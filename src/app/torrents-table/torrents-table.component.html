<div [ngClass]="{'dark-theme': isDarkTheme | async}" class="torrent-table-container">
    <!-- <button (click)="getTorrentData()">Get Torrents</button> -->

    <mat-spinner diameter=50 *ngIf="isLoading()"></mat-spinner>
    <p id="loading_p" *ngIf="isLoading()">Loading...</p>

    <app-bulk-update-torrents (onChange)="handleBulkEditChange($event)" *ngIf="!isLoading() && !isTorrentsEmpty()"></app-bulk-update-torrents>

    <!-- Table of torrent data -->
    <mat-table *ngIf="!isLoading() && !isTorrentsEmpty()" mat-table [dataSource]="dataSource" matSort (matSortChange)="onMatSortChange($event)" class="mat-elevation-z1"
        cdkDropList
        cdkDropListLockAxis="x" cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="handleColumnDragStopped($event)">

      <ng-container *ngFor="let column of displayedColumns; let i = index" [matColumnDef]="column">
        <mat-header-cell *matHeaderCellDef mat-sort-header cdkDrag>
            <div *ngIf="column !== 'select'">
              {{column}}
            </div>

            <mat-checkbox *ngIf="column === 'select'" color="primary" (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
        </mat-header-cell>

        <mat-cell *matCellDef="let torrent">
          <mat-checkbox *ngIf="column === 'select'" color="primary" (click)="$event.stopPropagation()"
                          (change)="$event ? handleTorrentSelected(torrent) : null"
                          [checked]="selection.isSelected(torrent)">
          </mat-checkbox>

          <div *ngIf="column === 'Actions'">
            <button color="warn" mat-icon-button matTooltip="Delete Torrent" matTooltipPosition="below" (click)="openDeleteTorrentDialog($event, [torrent])">
              <mat-icon>delete</mat-icon>
            </button>

            <button *ngIf="!isTorrentPaused(torrent)" mat-icon-button matTooltip="Pause Torrent" color="accent" matTooltipPosition="below"
            (click)="$event.stopPropagation();pauseTorrentsBulk([torrent])">
                <mat-icon>pause</mat-icon>
            </button>

            <button *ngIf="isTorrentPaused(torrent)" mat-icon-button matTooltip="Resume Torrent" color="primary" matTooltipPosition="below"
            (click)="$event.stopPropagation();resumeTorrentsBulk([torrent])">
                <mat-icon>play_arrow</mat-icon>
            </button>

            <button color="primary" mat-icon-button matTooltip="More Info" matTooltipPosition="right" (click)="openInfoTorrentDialog($event, torrent)">
                <mat-icon>info</mat-icon>
            </button>
          </div>

          <div *ngIf="column === 'Name'">
            {{torrent.name}}
          </div>

          <div *ngIf="column === 'Size'">
            {{getFileSizeString(torrent.size)}}
          </div>

          <p-progressBar class="custom_progress_bar {{torrent.progress > 0.5 ? 'white_label' : ''}} {{column === 'Progress' ? '' : 'hidden'}}"
              [value]="(torrent.progress * 100).toFixed(2)">
          </p-progressBar>

          <div *ngIf="column === 'Status'">
            <mat-chip-list>
              <mat-chip color="{{torrent.state === 'downloading' ? 'primary' : isTorrentError(torrent) ? 'accent':'default'}}" disableRipple selected>
                {{torrent.force_start ? '[F]' : ''}} {{getStatusString(torrent.state)}}
              </mat-chip>
            </mat-chip-list>
          </div>

          <div *ngIf="column === 'ETA'">
            {{getTorrentETAString(torrent)}}
          </div>

          <div *ngIf="column === 'Down Speed'">
            {{getFileSizeString(torrent.dlspeed)}}/s
          </div>

          <div *ngIf="column === 'Up Speed'">
            {{getFileSizeString(torrent.upspeed)}}/s
          </div>

          <div *ngIf="column === 'Completed On'">
            {{getCompletedOnString(torrent.completion_on)}}
          </div>
        </mat-cell>
      </ng-container>

      <!-- Header row of table -->
      <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
      <mat-row (click)="handleTorrentSelected(row)" class="{{isSelected(row) ? 'selected' : ''}}" *matRowDef="let row; columns: displayedColumns"></mat-row>
    </mat-table>
    <mat-paginator class="{{!isLoading() && !isTorrentsEmpty() && userPref.web_ui_options?.torrent_table?.paginate ? '' : 'hidden'}}"
                  [pageSize]="userPref.web_ui_options?.torrent_table?.default_items_per_page"
                  [pageSizeOptions]="pageSizeOptions"
                  (page)="onPaignationPageChanged()"
                  showFirstLastButtons={{userPref.web_ui_options?.torrent_table?.showFirstAndLastOptions}}>
    </mat-paginator>

    <div *ngIf="isTorrentsEmpty()">
      <p> No torrents found. Try adding one by clicking Upload at the top-right. </p>
    </div>

    <app-global-transfer-info *ngIf="!isLoading()"></app-global-transfer-info>
</div>

